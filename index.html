<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Formateador de medicación MUP</title>
    <!-- Bootstrap -->
    <link href="css/bootstrap-4.3.1.css" rel="stylesheet">
  <script>
	  var result = []
	  function loadFunction(){
//			var xhttp = new XMLHttpRequest();
//			xhttp.onreadystatechange = function() {
//				if (this.readyState == 4 && this.status == 200) {
//			 		document.getElementById("updateInfo").innerHTML = "Datos actualizados";
//					console.log(this.responseText)
//				} else {
//					document.getElementById("updateInfo").innerHTML = "No se ha podido comprobar la fecha de actualización";
//					console.log(this.responseText)
//				};
//		  
//			xhttp.open("GET", "fecha.txt", true);
//			xhttp.send();
//		  }
//		  
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
//			 		document.getElementById("demo").innerHTML = this.responseText;
					var lines = this.responseText.split("\n")

					// NOTE: If your columns contain commas in their values, you'll need
					// to deal with those before doing the next step 
					// (you might convert them to &&& or something, then covert them back later)
					// jsfiddle showing the issue https://jsfiddle.net/
					var headers=lines[0].split(",");

					for(var i=1;i<lines.length;i++){

					  var obj = {};
					  var currentline=lines[i].split(",");

					  for(var j=0;j<headers.length;j++){
						  obj[headers[j]] = currentline[j];
					  }

					  result.push(obj);

					}

				  //return result; //JavaScript object
				  console.log(JSON.stringify(result)); //JSON
					}
				};
		  
			xhttp.open("GET", "nomenclator.csv", true);
			xhttp.send();
	  }
	  
	  function testFunction(){
			var inputText = document.getElementById("muptext").value.split("\n")
			var drugLineList = []
			for (const i in inputText) {
				try {
					  var num = parseInt(inputText[i][0]);
					//console.log("num: " + num);
					} 
				catch (error) {
					  console.error(error);
						var num = inputText[i][0];
					console.log(num);
					  // expected output: ReferenceError: nonExistentFunction is not defined
					  // Note - error messages will vary depending on browser
					}
				if (Number.isInteger(num)){
					drugLineList.push(inputText[i]);	
				}
		  		else{
			  
		  }
			}
		  
		  	for (const l in drugLineList){
				console.log(drugLineList[l].split("   ")[0] + ", " + drugLineList[l].split("   ")[1].split(" ")[0])
//				for (const c in drugLineList[l]){
//					if (c > 2 && (drugLineList[l][c] == " ")){
//						console.log("test")
//					}
//				}
				
				for (var i = 0; i < result.length, i++){
					if (result[i]["Código Nacional"] == drugLineList[l].split("   ")[0]){
						console.log(result[i]["Principio activo o asociación de principios activos"])
					}
				}
			}
			
		 	document.getElementById("resulttext").innerHTML = drugLineList
	  }
	  </script>
  </head>
  <body onload="loadFunction()">
    <header>
      <div class="jumbotron">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <h1 class="text-center">Formateador de medicación MUP</h1>
              <p class="text-center">Copia el texto desde el MUP e introducelo en el cuadro de texto de abajo.</p>
				<p class="text-center" id="updateInfo" name="Update_info">Datos actualizados a fecha de</p>
              <p>&nbsp;</p>
              <p class="text-center"><a class="btn btn-primary btn-lg" href="#" role="button" onClick="testFunction()">Formatealo</a> </p>
            </div>
          </div>
        </div>
      </div>
    </header>
  <div class="container">
	  <div class="col-2"></div>
	  <div class="col-xl-auto">
		<div class="d-flex justify-content-center">
			<textarea class="" id="muptext" name="MUPText" rows="8" cols="150"></textarea>
		</div>
		  <hr>
		  <div class="d-flex justify-content-left">
			<div class="">
				Texto formateado:
			</div>
		  </div>
	  	<div class="col-12">
			  <div class="bg-light" id="resulttext" name="ResultText">
				  <p>Aquí se mostrará el texto resultado</p>
			  </div>
	    </div>
	  </div>
	  <div class="col-2"></div>
  </div>
	  <hr>
    <footer class="text-center">
      <div class="container">
        <div class="row">
          <div class="col-12">
            <p>Copyright © MyWebsite. All rights reserved.</p>
          </div>
        </div>
      </div>
    </footer>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) --> 
    <script src="js/jquery-3.3.1.min.js"></script> 
    <!-- Include all compiled plugins (below), or include individual files as needed --> 
    <script src="js/popper.min.js"></script> 
    <script src="js/bootstrap-4.3.1.js"></script>
	  <script src="js/papaparse.js"></script>
	  <script src="js/require.js"></script>
  </body>
</html>